// 初始化变量
var 排名 = -1;  // 玩家排名，初始值为-1
var 等级 = 77;  // 玩家等级，用于判断可获得的材料等级

var 给予 = {
	"1阶装备材料": {
		"等级70": {
			"材料": [
				[4000313, 18],      // 基础材料，数量18
				[0, 152542],         // 金币，数量152542
				[4033232, 2, 0.3],   // 特殊材料1，数量2，30%概率获得
				[4033104, 2, 0.3],   // 特殊材料2，数量2，30%概率获得
				[4033105, 1, 0.2],   // 特殊材料3，数量1，20%概率获得
				[4033106, 1, 0.2]    // 特殊材料4，数量1，20%概率获得
			]
		},
		"等级90": {
			"材料": [
				[
					4000313,
					27
				],
				[
					0,
					227675
				],
				[
					4033232,
					3,
					0.5
				],
				[
					4033104,
					3,
					0.5
				],
				[
					4033105,
					1,
					0.7
				],
				[
					4033106,
					1,
					0.7
				]
			]
		},
		"等级110": {
			"材料": [
				[
					4000313,
					40
				],
				[
					0,
					339813
				],
				[
					4033232,
					5,
					0.2
				],
				[
					4033104,
					5,
					0.2
				],
				[
					4033105,
					2,
					0.6
				],
				[
					4033106,
					2,
					0.6
				]
			]
		},
		"等级120": {
			"材料": [
				[
					4000313,
					60
				],
				[
					0,
					507185
				],
				[
					4033232,
					7,
					0.7
				],
				[
					4033104,
					7,
					0.7
				],
				[
					4033105,
					3,
					0.9
				],
				[
					4033106,
					3,
					0.9
				]
			]
		}
	},
	"2阶装备材料": {
		"等级130": {
			"材料": [
				[
					4000313,
					72
				],
				[
					0,
					723429
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	},
	"3阶装备材料": {
		"等级140": {
			"材料": [
				[
					4000313,
					76
				],
				[
					0,
					768652
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	},
	"4阶装备材料": {
		"等级150": {
			"材料": [
				[
					4000313,
					80
				],
				[
					0,
					845517
				],
				[
					4033232,
					7,
					0.3
				],
				[
					4033104,
					7,
					0.3
				],
				[
					4033105,
					3,
					0.7
				],
				[
					4033106,
					3,
					0.7
				]
			]
		}
	},
	"5阶装备材料": {
		"等级160": {
			"材料": [
				[
					4000313,
					84
				],
				[
					0,
					930069
				],
				[
					4033232,
					7,
					0.3
				],
				[
					4033104,
					7,
					0.3
				],
				[
					4033105,
					3,
					0.7
				],
				[
					4033106,
					3,
					0.7
				]
			]
		}
	},
	"6阶装备材料": {
		"等级170": {
			"材料": [
				[
					4000313,
					88
				],
				[
					0,
					1023076
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	},
	"7阶装备材料": {
		"等级180": {
			"材料": [
				[
					4000313,
					93
				],
				[
					0,
					1125384
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	},
	"8阶装备材料": {
		"等级190": {
			"材料": [
				[
					4000313,
					97
				],
				[
					0,
					1237922
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	},
	"9阶装备材料": {
		"等级200": {
			"材料": [
				[
					4000313,
					102
				],
				[
					0,
					1361714
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.7
				],
				[
					4033106,
					3,
					0.7
				]
			]
		}
	},
	"10阶装备材料": {
		"等级210": {
			"材料": [
				[
					4000313,
					107
				],
				[
					0,
					1497886
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.7
				],
				[
					4033106,
					3,
					0.7
				]
			]
		}
	},
	"11阶装备材料": {
		"等级220": {
			"材料": [
				[
					4000313,
					113
				],
				[
					0,
					1647674
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.7
				],
				[
					4033106,
					3,
					0.7
				]
			]
		}
	},
	"12阶装备材料": {
		"等级230": {
			"材料": [
				[
					4000313,
					118
				],
				[
					0,
					1812442
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	},
	"13阶装备材料": {
		"等级240": {
			"材料": [
				[
					4000313,
					124
				],
				[
					0,
					1993686
				],
				[
					4033232,
					7,
					0.5
				],
				[
					4033104,
					7,
					0.5
				],
				[
					4033105,
					3,
					0.8
				],
				[
					4033106,
					3,
					0.8
				]
			]
		}
	}
};
function start() {
	status = -1;
	action(1, 0, 0);
}
// ... existing code ...

// 脚本启动函数
function start() {
	status = -1;  // 初始化对话状态
	action(1, 0, 0);  // 开始对话
}

// 主要对话处理函数
function action(mode, type, selection) {
	if (mode == -1) {  // 如果玩家取消对话
		cm.dispose();  // 结束对话
	} else {
		if (status >= 0 && mode == 0) {  // 如果玩家在对话过程中选择取消
			cm.sendOk("感谢你的光临！");
			cm.dispose();
			return;
		}
		if (mode == 1) {  // 如果玩家选择确定
			status++;  // 对话状态+1
		} else {
			status--;  // 对话状态-1
		}
		
		if (status == 0) {  // 显示材料列表界面
			排名 = 1;
			var text = "";
			text += "  #w名次            伤害              名字  \r\n"
			// 遍历所有材料等级
			for (var i = 0; i < 给予.length; i++) {
				if (等级 < 给予["" + i + "阶装备材料"]) {
					var 当前材料 = 给予["" + i + "阶装备材料"];
					// 遍历每个等级段的材料
					for (var 等级段 in 当前材料) {
						var 等级要求 = parseInt(等级段.replace("等级", ""));
						if (cm.getLevel() >= 等级要求) {
							var 材料列表 = 当前材料[等级段]["材料"];
							text += "  #b获得 #r" + (i + 1) + "阶装备材料#k\r\n";
							// 显示每种材料的详细信息
							for (var j = 0; j < 材料列表.length; j++) {
								var 材料 = 材料列表[j];
								if (材料.length == 2) {  // 普通材料
									text += "  #b- #r" + 材料[1] + "个 #k材料ID:" + 材料[0] + "\r\n";
								} else if (材料.length == 3) {  // 概率材料
									text += "  #b- #r" + 材料[1] + "个 #k材料ID:" + 材料[0] + " (概率:" + (材料[2] * 100) + "%)#k\r\n";
								}
							}
						}
					}
					break;
				}
			}
			cm.sendSimpleS(text, 2);  // 发送材料列表界面
		} else if (status == 1) {  // 发放材料
			var 已给予 = false;  // 是否已发放材料的标志
			var 当前阶数 = 0;    // 当前材料等级
			// 遍历所有材料等级
			for (var i = 0; i < 给予.length; i++) {
				if (等级 < 给予["" + i + "阶装备材料"]) {
					当前阶数 = i + 1;
					var 当前材料 = 给予["" + i + "阶装备材料"];
					// 遍历每个等级段的材料
					for (var 等级段 in 当前材料) {
						var 等级要求 = parseInt(等级段.replace("等级", ""));
						if (cm.getLevel() >= 等级要求) {
							var 材料列表 = 当前材料[等级段]["材料"];
							// 发放每种材料
							for (var j = 0; j < 材料列表.length; j++) {
								var 材料 = 材料列表[j];
								if (材料.length == 2) {  // 发放普通材料
									cm.gainItem(材料[0], 材料[1]);
									已给予 = true;
								} else if (材料.length == 3) {  // 发放概率材料
									if (Math.random() < 材料[2]) {
										cm.gainItem(材料[0], 材料[1]);
										已给予 = true;
									}
								}
							}
						}
					}
					break;
				}
			}
			// 显示发放结果
			if (已给予) {
				cm.sendOk("成功领取 " + 当前阶数 + "阶装备材料奖励！");
			} else {
				cm.sendOk("您的等级不足，无法领取奖励！");
			}
			cm.dispose();  // 结束对话
		}
	}
}