var status = -1;
var itemList = [
    [[4500034, 3], [[4500116, 3], [4500117, 3], [4500118, 3], [4500119, 3], [4500120, 3], [4500121, 3], [4500122, 3], [4500123, 3], [4500124, 3], [4500125, 3], [4500126, 3], [4500127, 3], [4500128, 3]]],
    [[4500034, 3], [[4500216, 3], [4500217, 3], [4500218, 3], [4500219, 3], [4500220, 3], [4500221, 3], [4500222, 3], [4500223, 3], [4500224, 3], [4500225, 3], [4500226, 3], [4500227, 3], [4500228, 3]]],
    [[4500034, 3], [[4500316, 3], [4500317, 3], [4500318, 3], [4500319, 3], [4500320, 3], [4500321, 3], [4500322, 3], [4500323, 3], [4500324, 3], [4500325, 3], [4500326, 3], [4500327, 3], [4500328, 3]]],
    [[4500034, 3], [[4500416, 3], [4500417, 3], [4500418, 3], [4500419, 3], [4500420, 3], [4500421, 3], [4500422, 3], [4500423, 3], [4500424, 3], [4500425, 3], [4500426, 3], [4500427, 3], [4500428, 3]]],
    [[4500034, 7], [4500516, 30]],
    [[4500034, 7], [[4500616, 3], [4500617, 3], [4500618, 3], [4500619, 3], [4500620, 3], [4500621, 3], [4500622, 3], [4500623, 3], [4500624, 3], [4500625, 3], [4500626, 3], [4500627, 3], [4500628, 3]]],
    [[4500034, 7], [[4500816, 3], [4500817, 3], [4500818, 3], [4500819, 3], [4500820, 3], [4500821, 3], [4500822, 3], [4500823, 3], [4500824, 3], [4500825, 3], [4500826, 3], [4500827, 3], [4500828, 3]]],
    [[4500034, 12], [[4501116, 3], [4501117, 3], [4501118, 3], [4501119, 3], [4501120, 3], [4501121, 3], [4501122, 3], [4501123, 3], [4501124, 3], [4501125, 3], [4501126, 3], [4501127, 3], [4501128, 3]]],
    [[4500034, 12], [[4500916, 3], [4500917, 3], [4500918, 3], [4500919, 3], [4500920, 3], [4500921, 3], [4500922, 3], [4500923, 3], [4500924, 3], [4500925, 3], [4500926, 3], [4500927, 3], [4500928, 3]]],
    [[4500034, 12], [1902256, 1]]
];

var 每月累充 = 100000;

function start() {
    status = -1;
    action(1, 0, 0);
}

function action(mode, type, selection) {
    // 每月累充 = cm.getBossWeekLog("每月充值金额");
    // cm.sendOk(每月累充);
    // cm.dispose();
    var 档位 = getRechargeLevel(每月累充);

    if (mode == -1) {
        cm.dispose();
    } else {
        if (status >= 0 && mode == 0) {
            cm.dispose();
            return;
        }
        if (mode == 1) {
            status++;
        } else {
            status--;
        }

        if (status == 0) {
            if (档位 == -1) {
                cm.sendOk("未达到任何档位");
                cm.dispose();
                return;
            } else {
                cm.sendYesNo("已达到充值档位，是否进行领取奖励" + 档位);
            }
        } else if (status == 1) {
            // 检查背包空间
            if (!checkInventorySpace()) {
                cm.sendOk("背包空间不足，请确保装备栏、消耗栏和其他栏都至少有3个空位！");
                cm.dispose();
                return;
            }


            var 奖励 = itemList[档位];
            if (!奖励) {
                cm.sendOk("奖励配置错误，请联系管理员。");
                cm.dispose();
                return;
            }

            // 发放第一个奖励
            var id1 = 奖励[0][0];
            var count1 = 奖励[0][1];
            if (!发奖(id1, count1)) {
                return;
            }

            // 发放第二个奖励
            var second = 奖励[1];
            if (Array.isArray(second[0])) {
                // 是等级分组奖励
                var 等级 = cm.getPlayer().getLevel();
                var idx = getLevelIndex(等级);
                if (idx == -1 || idx >= second.length) {
                    cm.sendOk("您的等级不在奖励范围内，无法领取等级奖励。");
                    cm.dispose();
                    return;
                }
                var 等级奖励 = second[idx];
                var id2 = 等级奖励[0];
                var count2 = 等级奖励[1];
                if (!发奖(id2, count2)) {
                    return;
                }
            } else {
                // 不是等级分组奖励，直接发放
                var id2 = second[0];
                var count2 = second[1];
                if (!发奖(id2, count2)) {
                    return;
                }
            }
            cm.sendOk("奖励已发放！");

            cm.dispose();
        }
    }
}

function checkInventorySpace() {
    return cm.getSpace(1) >= 3 && cm.getSpace(2) >= 3 && cm.getSpace(4) >= 3;
}
function 发奖(itemId, count) {
    if (itemId == 0) {
        cm.gainMeso(count);
    } else {
        cm.gainItem(itemId, count);
    }
    return true;
}

function getLevelIndex(等级) {
    var levels = [120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240];
    for (var i = 0; i < levels.length; i++) {
        if (等级 <= levels[i]) {
            return i;
        }
    }
    return -1;
}

function getRechargeLevel(每月累充) {
    var rechargeLevels = [1000, 1500, 2000, 2500, 3500, 4500, 5500, 7000, 8500, 10000];
    for (var i = rechargeLevels.length - 1; i >= 0; i--) {
        if (每月累充 >= rechargeLevels[i]) {
            return i;
        }
    }
    return -1;
}