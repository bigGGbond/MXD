/* ==================
 脚本类型: NPC	    
 脚本作者: 游戏盒团队-维多利亚 
 联系扣扣: 297870163
 =====================
 */

 var status = -1;

 // 所有装备材料配置
 var 材料配置 = {
     武器: [
         {阶数: 1, 等级: 120, 升级材料: 4033104, 绑定材料: 4500216},
         {阶数: 2, 等级: 130, 升级材料: 4500202, 绑定材料: 4500217},
         {阶数: 3, 等级: 140, 升级材料: 4500203, 绑定材料: 4500218},
         {阶数: 4, 等级: 150, 升级材料: 4500204, 绑定材料: 4500219},
         {阶数: 5, 等级: 160, 升级材料: 4500205, 绑定材料: 4500220},
         {阶数: 6, 等级: 170, 升级材料: 4500206, 绑定材料: 4500221},
         {阶数: 7, 等级: 180, 升级材料: 4500207, 绑定材料: 4500222},
         {阶数: 8, 等级: 190, 升级材料: 4500208, 绑定材料: 4500223},
         {阶数: 9, 等级: 200, 升级材料: 4500209, 绑定材料: 4500224},
         {阶数: 10, 等级: 210, 升级材料: 4500210, 绑定材料: 4500225},
         {阶数: 11, 等级: 220, 升级材料: 4500211, 绑定材料: 4500226},
         {阶数: 12, 等级: 230, 升级材料: 4500212, 绑定材料: 4500227},
         {阶数: 13, 等级: 240, 升级材料: 4500213, 绑定材料: 4500228}
     ],
     衣服: [
         {阶数: 1, 等级: 120, 升级材料: 4033232, 绑定材料: 4500116},
         {阶数: 2, 等级: 130, 升级材料: 4500102, 绑定材料: 4500117},
         {阶数: 3, 等级: 140, 升级材料: 4500103, 绑定材料: 4500118},
         {阶数: 4, 等级: 150, 升级材料: 4500104, 绑定材料: 4500119},
         {阶数: 5, 等级: 160, 升级材料: 4500105, 绑定材料: 4500120},
         {阶数: 6, 等级: 170, 升级材料: 4500106, 绑定材料: 4500121},
         {阶数: 7, 等级: 180, 升级材料: 4500107, 绑定材料: 4500122},
         {阶数: 8, 等级: 190, 升级材料: 4500108, 绑定材料: 4500123},
         {阶数: 9, 等级: 200, 升级材料: 4500109, 绑定材料: 4500124},
         {阶数: 10, 等级: 210, 升级材料: 4500110, 绑定材料: 4500125},
         {阶数: 11, 等级: 220, 升级材料: 4500111, 绑定材料: 4500126},
         {阶数: 12, 等级: 230, 升级材料: 4500112, 绑定材料: 4500127},
         {阶数: 13, 等级: 240, 升级材料: 4500113, 绑定材料: 4500128}
     ],
     手套: [
         {阶数: 1, 等级: 120, 升级材料: 4033105, 绑定材料: 4500316},
         {阶数: 2, 等级: 130, 升级材料: 4500302, 绑定材料: 4500317},
         {阶数: 3, 等级: 140, 升级材料: 4500303, 绑定材料: 4500318},
         {阶数: 4, 等级: 150, 升级材料: 4500304, 绑定材料: 4500319},
         {阶数: 5, 等级: 160, 升级材料: 4500305, 绑定材料: 4500320},
         {阶数: 6, 等级: 170, 升级材料: 4500306, 绑定材料: 4500321},
         {阶数: 7, 等级: 180, 升级材料: 4500307, 绑定材料: 4500322},
         {阶数: 8, 等级: 190, 升级材料: 4500308, 绑定材料: 4500323},
         {阶数: 9, 等级: 200, 升级材料: 4500309, 绑定材料: 4500324},
         {阶数: 10, 等级: 210, 升级材料: 4500310, 绑定材料: 4500325},
         {阶数: 11, 等级: 220, 升级材料: 4500311, 绑定材料: 4500326},
         {阶数: 12, 等级: 230, 升级材料: 4500312, 绑定材料: 4500327},
         {阶数: 13, 等级: 240, 升级材料: 4500313, 绑定材料: 4500328}
     ],
     鞋子: [
         {阶数: 1, 等级: 120, 升级材料: 4033106, 绑定材料: 4500416},
         {阶数: 2, 等级: 130, 升级材料: 4500402, 绑定材料: 4500417},
         {阶数: 3, 等级: 140, 升级材料: 4500403, 绑定材料: 4500418},
         {阶数: 4, 等级: 150, 升级材料: 4500404, 绑定材料: 4500419},
         {阶数: 5, 等级: 160, 升级材料: 4500405, 绑定材料: 4500420},
         {阶数: 6, 等级: 170, 升级材料: 4500406, 绑定材料: 4500421},
         {阶数: 7, 等级: 180, 升级材料: 4500407, 绑定材料: 4500422},
         {阶数: 8, 等级: 190, 升级材料: 4500408, 绑定材料: 4500423},
         {阶数: 9, 等级: 200, 升级材料: 4500409, 绑定材料: 4500424},
         {阶数: 10, 等级: 210, 升级材料: 4500410, 绑定材料: 4500425},
         {阶数: 11, 等级: 220, 升级材料: 4500411, 绑定材料: 4500426},
         {阶数: 12, 等级: 230, 升级材料: 4500412, 绑定材料: 4500427},
         {阶数: 13, 等级: 240, 升级材料: 4500413, 绑定材料: 4500428}
     ],
     腰带: [
         {阶数: 1, 等级: 120, 升级材料: 4442300, 绑定材料: 4500616},
         {阶数: 2, 等级: 130, 升级材料: 4500602, 绑定材料: 4500617},
         {阶数: 3, 等级: 140, 升级材料: 4500603, 绑定材料: 4500618},
         {阶数: 4, 等级: 150, 升级材料: 4500604, 绑定材料: 4500619},
         {阶数: 5, 等级: 160, 升级材料: 4500605, 绑定材料: 4500620},
         {阶数: 6, 等级: 170, 升级材料: 4500606, 绑定材料: 4500621},
         {阶数: 7, 等级: 180, 升级材料: 4500607, 绑定材料: 4500622},
         {阶数: 8, 等级: 190, 升级材料: 4500608, 绑定材料: 4500623},
         {阶数: 9, 等级: 200, 升级材料: 4500609, 绑定材料: 4500624},
         {阶数: 10, 等级: 210, 升级材料: 4500610, 绑定材料: 4500625},
         {阶数: 11, 等级: 220, 升级材料: 4500611, 绑定材料: 4500626},
         {阶数: 12, 等级: 230, 升级材料: 4500612, 绑定材料: 4500627},
         {阶数: 13, 等级: 240, 升级材料: 4500613, 绑定材料: 4500628}
     ],
     披风: [
         {阶数: 1, 等级: 120, 升级材料: 4443300, 绑定材料: 4500816},
         {阶数: 2, 等级: 130, 升级材料: 4500802, 绑定材料: 4500817},
         {阶数: 3, 等级: 140, 升级材料: 4500803, 绑定材料: 4500818},
         {阶数: 4, 等级: 150, 升级材料: 4500804, 绑定材料: 4500819},
         {阶数: 5, 等级: 160, 升级材料: 4500805, 绑定材料: 4500820},
         {阶数: 6, 等级: 170, 升级材料: 4500806, 绑定材料: 4500821},
         {阶数: 7, 等级: 180, 升级材料: 4500807, 绑定材料: 4500822},
         {阶数: 8, 等级: 190, 升级材料: 4500808, 绑定材料: 4500823},
         {阶数: 9, 等级: 200, 升级材料: 4500809, 绑定材料: 4500824},
         {阶数: 10, 等级: 210, 升级材料: 4500810, 绑定材料: 4500825},
         {阶数: 11, 等级: 220, 升级材料: 4500811, 绑定材料: 4500826},
         {阶数: 12, 等级: 230, 升级材料: 4500812, 绑定材料: 4500827},
         {阶数: 13, 等级: 240, 升级材料: 4500813, 绑定材料: 4500828}
     ],
     坐骑: [
         {阶数: 1, 等级: 120, 升级材料: 4033062, 绑定材料: 4500916},
         {阶数: 2, 等级: 130, 升级材料: 4500902, 绑定材料: 4500917},
         {阶数: 3, 等级: 140, 升级材料: 4500903, 绑定材料: 4500918},
         {阶数: 4, 等级: 150, 升级材料: 4500904, 绑定材料: 4500919},
         {阶数: 5, 等级: 160, 升级材料: 4500905, 绑定材料: 4500920},
         {阶数: 6, 等级: 170, 升级材料: 4500906, 绑定材料: 4500921},
         {阶数: 7, 等级: 180, 升级材料: 4500907, 绑定材料: 4500922},
         {阶数: 8, 等级: 190, 升级材料: 4500908, 绑定材料: 4500923},
         {阶数: 9, 等级: 200, 升级材料: 4500909, 绑定材料: 4500924},
         {阶数: 10, 等级: 210, 升级材料: 4500910, 绑定材料: 4500925},
         {阶数: 11, 等级: 220, 升级材料: 4500911, 绑定材料: 4500926},
         {阶数: 12, 等级: 230, 升级材料: 4500912, 绑定材料: 4500927},
         {阶数: 13, 等级: 240, 升级材料: 4500913, 绑定材料: 4500928}
     ],
     神环: [
         {阶数: 1, 等级: 120, 升级材料: 4033255, 绑定材料: 4501116},
         {阶数: 2, 等级: 130, 升级材料: 4501102, 绑定材料: 4501117},
         {阶数: 3, 等级: 140, 升级材料: 4501103, 绑定材料: 4501118},
         {阶数: 4, 等级: 150, 升级材料: 4501104, 绑定材料: 4501119},
         {阶数: 5, 等级: 160, 升级材料: 4501105, 绑定材料: 4501120},
         {阶数: 6, 等级: 170, 升级材料: 4501106, 绑定材料: 4501121},
         {阶数: 7, 等级: 180, 升级材料: 4501107, 绑定材料: 4501122},
         {阶数: 8, 等级: 190, 升级材料: 4501108, 绑定材料: 4501123},
         {阶数: 9, 等级: 200, 升级材料: 4501109, 绑定材料: 4501124},
         {阶数: 10, 等级: 210, 升级材料: 4501110, 绑定材料: 4501125},
         {阶数: 11, 等级: 220, 升级材料: 4501111, 绑定材料: 4501126},
         {阶数: 12, 等级: 230, 升级材料: 4501112, 绑定材料: 4501127},
         {阶数: 13, 等级: 240, 升级材料: 4501113, 绑定材料: 4501128}
     ]
 };
 
 var 材料列表 = [
     {名称: "武器材料", 代码: 4500216, 数量: 10},
     {名称: "饰品材料", 代码: 4500516, 数量: 10},
     {名称: "神环材料", 代码: 4501116, 数量: 1},
     {名称: "手套材料", 代码: 4500316, 数量: 10},
     {名称: "腰带材料", 代码: 4500616, 数量: 2},
     {名称: "坐骑材料", 代码: 4500916, 数量: 1},
     {名称: "鞋子材料", 代码: 4500416, 数量: 10},
     {名称: "披风材料", 代码: 4500816, 数量: 2}
 ];
 
 function start() {
     status = -1;
     action(1, 0, 0);
 }
 
 function action(mode, type, selection) {
    var 等级 = cm.getPlayer().getLevel();
    if (mode == -1) {
        cm.dispose();
    } else {
        if (status >= 0 && mode == 0) {
            cm.dispose();
            return;
        }
        if (mode == 1)
            status++;
        else
            status--;

        if (status == 0) {
            // 检查是否有礼包
            if (!cm.haveItem(2022539, 1)) {
                cm.sendOk("你没有#v2022539#装备材料任选礼包。");
                cm.dispose();
                return;
            }

            // 检查等级是否达到要求
            if (等级 < 120) {
                cm.sendOk("你的等级不足120级，无法使用装备材料任选礼包。");
                cm.dispose();
                return;
            }

            var text = "#e#d请选择材料类型：#n#k\r\n\r\n";
            
            // 显示基础材料
            text += "#e基础材料：#n\r\n";
            // 按照单列布局显示基础材料
            for (var i = 0; i < 材料列表.length; i++) {
                var 材料 = 材料列表[i];
                text += "#L" + i + "##v" + 材料.代码 + "# #b" + 材料.名称 + "#k\r\n";
            }
            
            cm.sendSimple(text);
        } 
        else if (status == 1) {
            if (selection < 0 || selection >= 材料列表.length) {
                cm.sendOk("选择无效。");
                cm.dispose();
                return;
            }

            // 保存选择的基础材料类型
            var 选择的基础材料 = 材料列表[selection];
            
            // 获取玩家当前可用的最高阶数
            var 当前阶数 = getLevelIndex(等级) + 1;
            
            var text = "#e#d选择" + 选择的基础材料.名称 + "的升级材料：#n#k\r\n";
            text += "#d当前等级: " + 等级 + " 可使用最高阶数: " + 当前阶数 + " 阶#k\r\n\r\n";
            
            // 根据材料类型显示对应的升级材料
            var 材料类型 = 选择的基础材料.名称.replace("材料", "");
            if (材料配置[材料类型]) {
                // 计算当前等级对应的阶数
                var 当前等级阶数 = 0;
                for (var i = 0; i < 材料配置[材料类型].length; i++) {
                    if (等级 >= 材料配置[材料类型][i].等级) {
                        当前等级阶数 = i;
                    }
                }
                
                // 显示上一阶、当前阶、下一阶的材料
                for (var i = Math.max(0, 当前等级阶数 - 1); i <= Math.min(当前等级阶数 + 1, 材料配置[材料类型].length - 1); i++) {
                    var 材料 = 材料配置[材料类型][i];
                    var 阶数描述 = "";
                    if (i < 当前等级阶数) {
                        阶数描述 = "#r[低一阶]#k ";
                    } else if (i > 当前等级阶数) {
                        阶数描述 = "#g[高一阶]#k ";
                    } else {
                        阶数描述 = "#b[当前阶]#k ";
                    }
                    
                    if (等级 >= 材料.等级) {
                        text += "#L" + (100000 + i * 2) + "##v" + 材料.升级材料 + "# " + 阶数描述 + 材料.阶数 + "阶升级材料 (需要等级:" + 材料.等级 + ")#k\r\n";
                        // text += "#L" + (100001 + i * 2) + "##v" + 材料.绑定材料 + "# " + 阶数描述 + 材料.阶数 + "阶绑定材料 (需要等级:" + 材料.等级 + ")#k\r\n";
                    } else {
                        text += "#v" + 材料.升级材料 + "# " + 阶数描述 + 材料.阶数 + "阶升级材料 #r(需要等级:" + 材料.等级 + ")#k\r\n";
                        // text += "#v" + 材料.绑定材料 + "# " + 阶数描述 + 材料.阶数 + "阶绑定材料 #r(需要等级:" + 材料.等级 + ")#k\r\n";
                    }
                }
            } else {
                // 如果是基础材料，直接给予
                text += "#L" + selection + "##v" + 选择的基础材料.代码 + "# #b" + 选择的基础材料.名称 + " × " + 选择的基础材料.数量 + "#k\r\n";
            }
            
            cm.sendSimple(text);
        }
        else if (status == 2) {
            var 选择材料;
            
            if (selection < 100000) {
                // 选择的是基础材料
                选择材料 = 材料列表[selection];
            } else {
                // 选择的是升级材料
                var 材料索引 = Math.floor((selection - 100000) / 2);
                var 是否绑定 = (selection - 100000) % 2;
                
                // 获取对应的装备类型
                var 上一次选择 = 材料列表[status - 2]; // 获取上一步选择的基础材料
                var 装备类型 = 上一次选择.名称.replace("材料", "");
                
                var 升级材料 = 材料配置[装备类型][材料索引];
                
                // 检查等级是否满足要求
                if (等级 < 升级材料.等级) {
                    cm.sendOk("你的等级不足 " + 升级材料.等级 + " 级，无法领取该材料。");
                    cm.dispose();
                    return;
                }
                
                选择材料 = {
                    名称: 装备类型 + 升级材料.阶数 + "阶" + (是否绑定 ? "绑定" : "升级") + "材料",
                    代码: 是否绑定 ? 升级材料.绑定材料 : 升级材料.升级材料,
                    数量: 1
                };
            }
            
            // 扣除礼包
            cm.gainItem(2022539, -1);
            
            // 获得选择的材料
            cm.gainItem(选择材料.代码, 选择材料.数量);
            
            // 发送成功消息
            cm.sendOk("成功获得 #v" + 选择材料.代码 + "# " + 选择材料.名称 + " × " + 选择材料.数量);
            
            // 全服公告
            cm.全服黄色喇叭(cm.getPlayer().getName() + " : 从装备材料任选礼包中获得了 " + 选择材料.名称 + " × " + 选择材料.数量);
            
            cm.dispose();
        }
    }
}

function getLevelIndex(level) {
    if (level < 120) return -1;
    var 等级列表 = [120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240];
    for (var i = 0; i < 等级列表.length; i++) {
        if (level < 等级列表[i]) {
            return i - 1;
        }
    }
    return 等级列表.length - 1;
}