var status = -1;

// 充值档位列表
var rechargeLevels = [500, 1000, 2000, 3000, 5000, 7000, 10000, 14000, 20000, 30000, 40000, 50000, 60000, 70000, 80000, 90000, 100000, 110000, 120000, 130000,
    140000, 150000, 160000, 170000, 180000, 190000, 200000, 210000, 220000, 230000, 240000, 250000, 260000, 270000, 280000, 290000, 300000, 310000, 320000,
    330000, 340000, 350000, 360000, 370000, 380000, 390000, 400000, 410000, 420000, 430000, 440000, 450000, 460000, 470000, 480000, 490000, 500000];

// 勋章配置
var 勋章配置 = [
    { 档位: 1, 代码: 1142443, 名称: "至尊勋章", HP: 23, MP: 23, 攻击力: 9, 魔法力: 9 },
    { 档位: 2, 代码: 1143028, 名称: "人级", HP: 67, MP: 67, 攻击力: 27, 魔法力: 27 },
    { 档位: 3, 代码: 1143021, 名称: "王级", HP: 156, MP: 156, 攻击力: 62, 魔法力: 62 },
    { 档位: 4, 代码: 1142612, 名称: "神级", HP: 307, MP: 307, 攻击力: 123, 魔法力: 123 },
    { 档位: 5, 代码: 1142524, 名称: "圣级", HP: 640, MP: 640, 攻击力: 256, 魔法力: 256 },
    { 档位: 6, 代码: 1143043, 名称: "天级", HP: 1033, MP: 1033, 攻击力: 413, 魔法力: 413 },
    { 档位: 7, 代码: 1142745, 名称: "祖级", HP: 1584, MP: 1584, 攻击力: 633, 魔法力: 633 },
    { 档位: 8, 代码: 1143024, 名称: "霸级", HP: 2099, MP: 2099, 攻击力: 839, 魔法力: 839 },
    { 档位: 9, 代码: 1142746, 名称: "仙级", HP: 2744, MP: 2744, 攻击力: 1098, 魔法力: 1098 },
    { 档位: 10, 代码: 1143037, 名称: "尊者级", HP: 3354, MP: 3354, 攻击力: 1341, 魔法力: 1341 },
    { 档位: 11, 代码: 1143012, 名称: "星辰级", HP: 3937, MP: 3937, 攻击力: 1575, 魔法力: 1575 },
    { 档位: 12, 代码: 1143085, 名称: "银河级", HP: 4637, MP: 4637, 攻击力: 1855, 魔法力: 1855 },
    { 档位: 13, 代码: 1143000, 名称: "宇宙级", HP: 5314, MP: 5314, 攻击力: 2125, 魔法力: 2125 },
    { 档位: 14, 代码: 1143160, 名称: "黄昏级", HP: 5972, MP: 5972, 攻击力: 2389, 魔法力: 2389 },
    { 档位: 15, 代码: 1143159, 名称: "湮灭级", HP: 6744, MP: 6744, 攻击力: 2698, 魔法力: 2698 },
    { 档位: 16, 代码: 1143194, 名称: "黑洞级", HP: 7500, MP: 7500, 攻击力: 3000, 魔法力: 3000 }
];

// 充值档位奖励配置
var 充值档位 = {
    500: { 类型: "血石", 数量: 10 },
    1000: { 类型: "勋章", 等级: 1 },
    2000: { 类型: "血石", 数量: 20 },
    3000: { 类型: "勋章", 等级: 2 },
    5000: { 类型: "血石", 数量: 20 },
    7000: { 类型: "勋章", 等级: 3 },
    10000: { 类型: "血石", 数量: 20 },
    14000: { 类型: "勋章", 等级: 4 },
    20000: { 类型: "血石", 数量: 20 },
    30000: { 类型: "勋章", 等级: 5 },
    40000: { 类型: "血石", 数量: 20 },
    50000: { 类型: "勋章", 等级: 6 },
    60000: { 类型: "血石", 数量: 20 },
    70000: { 类型: "血石", 数量: 20 },
    80000: { 类型: "勋章", 等级: 7 },
    90000: { 类型: "血石", 数量: 20 },
    100000: { 类型: "血石", 数量: 20 },
    110000: { 类型: "勋章", 等级: 8 },
    120000: { 类型: "血石", 数量: 20 },
    130000: { 类型: "血石", 数量: 20 },
    140000: { 类型: "血石", 数量: 20 },
    150000: { 类型: "勋章", 等级: 9 },
    160000: { 类型: "血石", 数量: 20 },
    170000: { 类型: "血石", 数量: 20 },
    180000: { 类型: "血石", 数量: 20 },
    190000: { 类型: "勋章", 等级: 10 },
    200000: { 类型: "血石", 数量: 20 },
    210000: { 类型: "血石", 数量: 20 },
    220000: { 类型: "血石", 数量: 20 },
    230000: { 类型: "勋章", 等级: 11 },
    240000: { 类型: "血石", 数量: 20 },
    250000: { 类型: "血石", 数量: 20 },
    260000: { 类型: "血石", 数量: 20 },
    270000: { 类型: "血石", 数量: 20 },
    280000: { 类型: "勋章", 等级: 12 },
    290000: { 类型: "血石", 数量: 20 },
    300000: { 类型: "血石", 数量: 20 },
    310000: { 类型: "血石", 数量: 20 },
    320000: { 类型: "血石", 数量: 20 },
    330000: { 类型: "勋章", 等级: 13 },
    340000: { 类型: "血石", 数量: 20 },
    350000: { 类型: "血石", 数量: 20 },
    360000: { 类型: "血石", 数量: 20 },
    370000: { 类型: "血石", 数量: 20 },
    380000: { 类型: "勋章", 等级: 14 },
    390000: { 类型: "血石", 数量: 20 },
    400000: { 类型: "血石", 数量: 20 },
    410000: { 类型: "血石", 数量: 20 },
    420000: { 类型: "血石", 数量: 20 },
    430000: { 类型: "血石", 数量: 20 },
    440000: { 类型: "勋章", 等级: 15 },
    450000: { 类型: "血石", 数量: 20 },
    460000: { 类型: "血石", 数量: 20 },
    470000: { 类型: "血石", 数量: 20 },
    480000: { 类型: "血石", 数量: 20 },
    490000: { 类型: "血石", 数量: 20 },
    500000: { 类型: "勋章", 等级: 16 }
};

function start() {
    status = -1;
    action(1, 0, 0);
}

function get勋章(等级) {
    for (var i = 0; i < 勋章配置.length; i++) {
        if (勋章配置[i].档位 === 等级) {
            return 勋章配置[i];
        }
    }
    return null;
}

function action(mode, type, selection) {
    var 累充积分 = cm.getBossRank9("充值金额", 2);
    var 当前等级 = getRechargeLevel(累充积分);
    var 当前档位 = 0;
    
    // 根据充值档位获取对应的充值金额
    if (当前等级 > 0) {
        当前档位 = rechargeLevels[当前等级 - 1];
    }
    
    // var debug = "调试信息：\r\n";
    // debug += "累充积分: " + 累充积分 + "\r\n";
    // debug += "当前等级: " + 当前等级 + "\r\n";
    // debug += "当前档位: " + 当前档位 + "\r\n";
    // debug += "奖励数据: " + (充值档位[当前档位] ? JSON.stringify(充值档位[当前档位]) : "未找到") + "\r\n";
    // cm.sendOk(debug);
    
    var 奖励 = 当前等级 > 0 ? 充值档位[当前档位] : null;
    
    if (mode == -1 || mode == 0) {
        cm.dispose();
        return;
    }

    if (mode == 1) {
        status++;
    } else {
        status--;
    }

    if (status == 0) {
        if (当前等级 <= 0 || !奖励) {
            cm.sendOk("未达到任何奖励领取条件。");
            cm.dispose();
            return;
        }

        var text = "#e#r[充值奖励]#k#n\r\n";
        text += "#b当前充值金额：#r" + 累充积分 + "#k\r\n";
        text += "#b当前充值档位：#r" + 当前等级 + "#k\r\n\r\n";
        
        if (奖励.类型 === "勋章") {
            var 勋章 = get勋章(奖励.等级);
            if (!勋章) {
                cm.sendOk("获取勋章数据失败。");
                cm.dispose();
                return;
            }
            text += "#b可领取奖励：#r" + 勋章.名称 + "#k\r\n\r\n";
            text += "#e勋章属性：#n\r\n";
            text += "HP/MP：+" + 勋章.HP + "\r\n";
            text += "攻击力/魔法力：+" + 勋章.攻击力 + "\r\n";
        } else {
            text += "#b可领取奖励：#r血石 x " + 奖励.数量 + "#k\r\n";
        }
        
        text += "\r\n是否领取奖励？";
        cm.sendYesNo(text);
    } else if (status == 1) {
        if (!奖励) {
            cm.sendOk("发生错误，请重试。");
            cm.dispose();
            return;
        }

        if (奖励.类型 === "勋章") {
            var 勋章 = get勋章(奖励.等级);
            if (!勋章) {
                cm.sendOk("获取勋章数据失败。");
                cm.dispose();
                return;
            }
            
            // 检查背包空间
            if (!cm.canHold(勋章.代码)) {
                cm.sendOk("背包空间不足，请清理后再试。");
                cm.dispose();
                return;
            }

            // 创建勋章
            var equip = cm.getEquip(勋章.代码);
            equip.setStr(0);
            equip.setDex(0);
            equip.setInt(0);
            equip.setLuk(0);
            equip.setHp(勋章.HP);
            equip.setMp(勋章.MP);
            equip.setWatk(勋章.攻击力);
            equip.setMatk(勋章.魔法力);
            equip.setWdef(0);
            equip.setMdef(0);
            equip.setAvoid(0);
            equip.setAcc(0);
            equip.setJump(0);
            equip.setSpeed(0);
            
            // 给予勋章
            cm.addFromDrop(equip);
            cm.sendOk("#e#r领取成功！#k#n\r\n获得：#v" + 勋章.代码 + "# " + 勋章.名称);
        } else {
            // 给予血石
            cm.gainItem(2022582, 奖励.数量); // 血石道具ID
            cm.sendOk("#e#r领取成功！#k#n\r\n获得：#v2022582# x " + 奖励.数量);
        }
        
        cm.dispose();
    }
}

function getRechargeLevel(累充积分) {
    for (var i = rechargeLevels.length - 1; i >= 0; i--) {
        if (累充积分 >= rechargeLevels[i]) {
            return i + 1;
        }
    }
    return -1;
}