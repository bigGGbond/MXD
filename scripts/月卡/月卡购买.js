var 美化1 = "#fUI/ChatBalloon.img/pet/260/nw#"; //选择道具
var 美化3 = "#fUI/ChatBalloon.img/pet/260/ne#"; //选择道具
var 美化2 = "#fUI/ChatBalloon.img/pet/260/n#"; //选择道具
var 美化4 = "#fUI/ChatBalloon.img/pet/260/sw#"; //选择道具
var 美化5 = "#fUI/ChatBalloon.img/pet/260/se#"; //选择道具
var 美化6 = "#fUI/ChatBalloon.img/pet/260/s#"; //选择道具

var 元宝价格 = 6000; // 设置价格
var 状态 = 0;
var 月卡物品ID = 5600001;

// 奖励配置
var 奖励配置 = [
    {最小等级: 0, 最大等级: 120, 枫叶数量: 15, 枫叶概率: 6.07, 暗影币数量: 2, 暗影币概率: 50.0},
    {最小等级: 121, 最大等级: 130, 枫叶数量: 18, 枫叶概率: 22.81, 暗影币数量: 3, 暗影币概率: 65.6},
    {最小等级: 131, 最大等级: 140, 枫叶数量: 19, 枫叶概率: 14.75, 暗影币数量: 3, 暗影币概率: 82.5},
    {最小等级: 141, 最大等级: 150, 枫叶数量: 20, 枫叶概率: 10.33, 暗影币数量: 4, 暗影币概率: 2.0},
    {最小等级: 151, 最大等级: 160, 枫叶数量: 21, 枫叶概率: 10.33, 暗影币数量: 4, 暗影币概率: 22.0},
    {最小等级: 161, 最大等级: 170, 枫叶数量: 22, 枫叶概率: 16.25, 暗影币数量: 4, 暗影币概率: 43.3},
    {最小等级: 171, 最大等级: 180, 枫叶数量: 23, 枫叶概率: 26.88, 暗影币数量: 4, 暗影币概率: 65.8},
    {最小等级: 181, 最大等级: 190, 枫叶数量: 24, 枫叶概率: 43.38, 暗影币数量: 4, 暗影币概率: 88.3},
    {最小等级: 191, 最大等级: 200, 枫叶数量: 25, 枫叶概率: 65.80, 暗影币数量: 5, 暗影币概率: 13.0},
    {最小等级: 201, 最大等级: 210, 枫叶数量: 26, 枫叶概率: 93.50, 暗影币数量: 5, 暗影币概率: 38.8},
    {最小等级: 211, 最大等级: 220, 枫叶数量: 28, 枫叶概率: 28.50, 暗影币数量: 5, 暗影币概率: 65.8},
    {最小等级: 221, 最大等级: 230, 枫叶数量: 29, 枫叶概率: 70.00, 暗影币数量: 5, 暗影币概率: 94.0},
    {最小等级: 231, 最大等级: 240, 枫叶数量: 31, 枫叶概率: 18.33, 暗影币数量: 6, 暗影币概率: 23.5}
];

function 获取等级奖励(等级) {
    for (var i = 0; i < 奖励配置.length; i++) {
        if (等级 >= 奖励配置[i].最小等级 && 等级 <= 奖励配置[i].最大等级) {
            return 奖励配置[i];
        }
    }
    return null;
}

// 概率函数
function 获取随机数(最小值, 最大值) {
    return Math.random() * (最大值 - 最小值) + 最小值;
}

function start() {
    状态 = -1;
    action(1, 0, 0);
}

function action(mode, type, selection) {
    var 等级 = cm.getPlayer().getLevel();
    if (mode == -1) {
        cm.dispose();
    } else {
        if (状态 >= 0 && mode == 0) {
            cm.dispose();
            return;
        }
        if (mode == 1) {
            状态++;
        } else {
            cm.dispose();
            return;
        }
        
        // 检查玩家是否有月卡
        var 拥有月卡 = cm.getPlayer().getItemQuantity(月卡物品ID, false) > 0;
        if (状态 == 0) {
            if (!拥有月卡) {
                // 显示购买月卡界面
                var 文本 = "#k#d" + 美化1 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "#r#e『每日月卡』#d#n(购买月卡)" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化3 + "#w#k#e\r\n\r\n"
                文本 += "您还没有月卡，是否愿意花费#r" + 元宝价格 + "元宝#k来购买月卡？\r\n";
                文本 += "\r\n购买后可获得月卡物品，每日可领取对应等级的奖励。";
                cm.sendYesNo(文本);
            } else {
                // 显示领取奖励界面
                var 奖励 = 获取等级奖励(等级);
                var 文本 = "#k#d" + 美化1 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "#r#e『每日月卡』#d#n(领取奖励)" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化2 + "" + 美化3 + "#w#k#e\r\n\r\n"
                
                // 检查是否已领取今日奖励
                if (cm.getBossLog("月卡每日奖励") >= 1) {
                    文本 += "#r今日已领取过奖励，请明天再来！#k";
                    cm.sendOk(文本);
                    cm.dispose();
                    return;
                }
                
                文本 += "#b今日可领取月卡奖励：#k\r\n";
                if (奖励) {
                    文本 += "\r\n当前等级(" + 等级 + ")可获得的奖励:\r\n";
                    文本 += "绑定枫叶: " + 奖励.枫叶数量 + "\r\n";
                    文本 += "绑定暗影币: " + 奖励.暗影币数量 + "\r\n";
                }
                cm.sendYesNo(文本);
            }
        } else if (状态 == 1) {
            if (!拥有月卡) {
                // 购买月卡逻辑
                if (cm.getBossLog("月卡购买") > 0) {
                    cm.sendOk("您已经购买过了月卡，请确认！");
                    cm.dispose();
                } else if (cm.getPlayer().getzb() < 元宝价格) {
                    cm.sendOk("您的元宝不足，无法购买月卡。");
                    cm.dispose();
                } else {
                    // 扣除元宝
                    cm.getPlayer().gainzb(-元宝价格);
                    // 发放月卡物品
                    cm.gainItem(月卡物品ID, 1);
                    // 记录购买
                    cm.setBossLog("月卡购买");
                    
                    cm.sendOk("成功购买了月卡！\r\n获得:\r\n月卡 x 1\r\n\r\n#r请重新打开NPC领取今日奖励！#k");
                    cm.全服黄色喇叭(cm.getPlayer().getName() + " [★★★月卡★★★]" + " : " + "成功购买了月卡！");
                    cm.dispose();
                }
            } else {
                // 领取奖励逻辑
                if (cm.getBossLog("月卡每日奖励") >= 1) {
                    cm.sendOk("您今天已经领取过奖励了，请明天再来！");
                    cm.dispose();
                    return;
                }
                
                var 奖励 = 获取等级奖励(等级);
                if (奖励) {
                    // 计算实际奖励数量
                    var 枫叶数量 = 奖励.枫叶数量;
                    var 暗影币数量 = 奖励.暗影币数量;
                    
                    // 计算额外奖励
                    if (获取随机数(0, 100) < 奖励.枫叶概率) {
                        枫叶数量 += 1;
                    }
                    if (获取随机数(0, 100) < 奖励.暗影币概率) {
                        暗影币数量 += 1;
                    }
                    
                    // 发放奖励
                    cm.gainItem(4500033, 枫叶数量); // 绑定枫叶
                    cm.gainItem(4500034, 暗影币数量); // 绑定暗影币
                    
                    // 记录领取
                    cm.setBossLog("月卡每日奖励");
                    
                    var 奖励文本 = "成功领取了今日月卡奖励！\r\n获得:\r\n";
                    奖励文本 += "绑定枫叶 x " + 枫叶数量 + "\r\n";
                    奖励文本 += "绑定暗影币 x " + 暗影币数量;
                    
                    cm.sendOk(奖励文本);
                    cm.全服黄色喇叭(cm.getPlayer().getName() + " [★★★月卡★★★]" + " : " + "成功领取了月卡奖励！");
                }
                cm.dispose();
            }
        }
    }
}


